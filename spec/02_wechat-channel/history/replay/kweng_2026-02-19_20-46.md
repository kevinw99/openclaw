# Spec 02: wechat-channel - Session Replay

## Session: 2026-02-19T20:46 ~ 20:47

> Person: kweng | Messages: 40 | Turns: 1

---

### 20:46 - Implement the following plan:

**Prompt:**

> Implement the following plan:
>
> # Plan: Three-Tier Session History + TASK Entity Type
>
> ## Context

<details>
<summary>Full prompt (6223 chars)</summary>

Implement the following plan:

# Plan: Three-Tier Session History + TASK Entity Type

## Context

The session history system currently puts `history/` directories inside EVERY entity directory — including source code (`src/whatsapp/history/`), docs (`docs/channels/history/`), and extensions (`extensions/wechat/history/`). This pollutes 19 code/content directories in openclaw and 8 in Enpack_CCC with generated files.

Only SPEC entities (and the new TASK type) should have inline history. All other entity types should store history centrally under `会话历史/entities/`.

Additionally, there's no TASK entity type for operational work that doesn't warrant a full spec.

Changes go to `~/AI/base` first (canonical source), then pull into both projects.

---

## Step 1: Modify `~/AI/base/src/session_history/models/category.py`

**Add TASK to EntityType, replace history_dir property with field:**

```python
class EntityType(Enum):
    SPEC = "spec"
    TASK = "task"              # NEW
    SOURCE = "source"
    RESEARCH = "research"
    KNOWLEDGE = "knowledge"
    TOOL = "tool"
    UNCATEGORIZED = "uncategorized"

INLINE_HISTORY_TYPES = {EntityType.SPEC, EntityType.TASK}
```

Replace the `history_dir` `@property` with a plain field `history_dir: str = ""` — set at construction time by EntityRegistry rather than computed.

---

## Step 2: Modify `~/AI/base/src/session_history/config/entity_registry.py`

**Three changes:**

### 2a: Add TASK discovery

```python
_TASK_DIRS = ["tasks", "任务"]
```

New `_discover_tasks()` method — same pattern as `_discover_specs()` but also accepts plain kebab-case names (not just `##_name`).

### 2b: Add history dir resolution

New `_resolve_history_dirs()` method called at end of `discover_all()`:

```python
def _resolve_history_dirs(self, entities):
    for entity in entities:
        if entity.entity_type in INLINE_HISTORY_TYPES:
            entity.history_dir = f"{entity.directory}/history"
        else:
            entity.history_dir = f"{self.history_root}/entities/{entity.entity_type.value}/{entity.name}"
```

### 2c: Update constructor and discover_all()

Constructor takes `history_root: str = "会话历史"` parameter. `discover_all()` calls `_discover_tasks()` and `_resolve_history_dirs()`.

---

## Step 3: Modify `~/AI/base/src/session_history/main.py`

Pass `settings.history_root` when constructing `EntityRegistry` (2 call sites: `cmd_scan` line 49, `_load_entity_index` line 174).

---

## Step 4: Modify `~/AI/base/src/session_history/generator/readable_replay_generator.py`

Pass `history_root` to `EntityRegistry` constructor (1 call site).

---

## Step 5: Modify `~/AI/base/src/session_history/config/settings.py`

Add `"task": "任务"` to the `entity_dirs` dict (backward compat).

---

## Step 6: Update tests in `~/AI/base`

- All test Entity objects need explicit `history_dir=` field (no longer auto-computed)
- Files: `tests/test_generators.py`, `tests/test_classifier.py`
- Run: `cd ~/AI/base/src && python3 -m pytest session_history/tests/ -v`

---

## Step 7: Commit and push base

```bash
cd ~/AI/base
git add src/session_history/
git commit -m "Add TASK entity type; three-tier history storage (inline/centralized/uncategorized)"
git push origin main
```

---

## Step 8: Pull into openclaw, clean up, re-scan

```bash
cd ~/AI/openclaw
git fetch base && git merge base/main
```

Delete old history dirs from source/docs/extensions:

```bash
rm -rf src/{types,config,plugins,web,terminal,shared,cli,line,whatsapp,channels}/history
rm -rf docs/{tools,install,plugins,cli,channels}/history
rm -rf extensions/{open-prose,feishu,wechat,google-gemini-cli-auth}/history
```

Re-scan:

```bash
cd src && python3 -m session_history scan
```

---

## Step 9: Pull into Enpack_CCC, clean up, re-scan

Add base remote (Enpack_CCC doesn't have one yet):

```bash
cd ~/AI/Enpack_CCC
git remote add base https://github.com/kevinw99/ai-project-base.git
git fetch base && git merge base/main --allow-unrelated-histories
```

Resolve conflicts: accept base version at `src/session_history/`, delete old `源代码/session_history/`.

Update the session_history hook in `.claude/settings.json` to use new path:

```
cd "$(git rev-parse --show-toplevel)/src" && python3 -m session_history scan -i
```

Delete old history dirs:

```bash
rm -rf 源代码/{chunked_processor,experiment_analyzer,doc_indexer,session-persistence}/history
rm -rf 知识库/{01_公司档案,99_图片资料归档}/history
rm -rf 工具/history 研究/状态报告/history
rm -rf 源代码/session_history  # old standalone copy
```

Re-scan:

```bash
cd src && python3 -m session_history scan
```

---

## Step 10: Verify both repos

For each repo:

1. `python3 -m session_history stats` — same session counts as before
2. `python3 -m session_history list` — all sessions classified
3. No `history/` dirs remain under src/, extensions/, docs/, 源代码/, 知识库/, 工具/
4. Spec history dirs still work inline: `spec/*/history/`
5. Centralized history exists: `会话历史/entities/source/*/sessions-index.json`
6. Replay works for both inline and centralized entities

---

## Files Changed (all in ~/AI/base/src/session_history/)

| File                                     | Change                                                                            |
| ---------------------------------------- | --------------------------------------------------------------------------------- |
| `models/category.py`                     | Add TASK enum, INLINE_HISTORY_TYPES, replace history_dir property → field         |
| `config/entity_registry.py`              | Add \_TASK_DIRS, \_discover_tasks(), \_resolve_history_dirs(), update constructor |
| `config/settings.py`                     | Add "task" to entity_dirs                                                         |
| `main.py`                                | Pass history_root to EntityRegistry (2 sites)                                     |
| `generator/readable_replay_generator.py` | Pass history_root to EntityRegistry (1 site)                                      |
| `tests/test_generators.py`               | Set history_dir field on Entity objects                                           |
| `tests/test_classifier.py`               | Set history_dir field on Entity objects                                           |

## After Pulling (per project)

| Action                          | openclaw       | Enpack_CCC                |
| ------------------------------- | -------------- | ------------------------- |
| Delete old history dirs         | 19 dirs        | 8 dirs                    |
| Delete old session_history copy | N/A            | `源代码/session_history/` |
| Add base remote                 | Already exists | New                       |
| Re-scan                         | Yes            | Yes                       |

If you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: /Users/kweng/.claude/projects/-Users-kweng-AI-openclaw/9347e2ce-4961-4b2d-8722-cdfcbda16ccf.jsonl

</details>

**Result:**
I'll start by reading the key files in `~/AI/base/src/session_history/` to understand the current code before making changes.

Now let me read the test files.

Let me also check how `IndexGenerator.write_entity_index` uses `history_dir`.

Good, I have a complete picture of the code. Let me create the task list and start implementing.

_Tools: Read (8), TaskCreate (8) -- /Users/kweng/AI/base/src/session_history/config/entity_registry.py, /Users/kweng/AI/base/src/session_history/config/settings.py, /Users/kweng/AI/base/src/session_history/generator/index_generator.py, /Users/kweng/AI/base/src/session_history/generator/readable_replay_generator.py, /Users/kweng/AI/base/src/session_history/main.py +3 more_

---
